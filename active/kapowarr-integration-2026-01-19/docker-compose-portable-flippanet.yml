# Flippanet Stack - Portable Edition
# Designed for lift-and-land migration (Windows â†’ Orange Pi)
#
# FEATURES:
# - Tailscale container for remote access (portable with stack)
# - Gluetun VPN with ProtonVPN port forwarding
# - Plex container (for ARM/Orange Pi compatibility)
# - Pi-hole for network-wide ad blocking & DNS
# - Environment variables for all paths
# - All images support ARM64 (Orange Pi compatible)
#
# REQUIRED ENV VARS (in .env file):
# - DATA_PATH=/path/to/your/media        (e.g., F:\Plex Media or /mnt/media)
# - TZ=America/Chicago                    (your timezone)
# - PUID=1000                             (user ID)
# - PGID=1000                             (group ID)
# - PROTONVPN_USER=xxx                    (ProtonVPN OpenVPN username)
# - PROTONVPN_PASSWORD=xxx                (ProtonVPN OpenVPN password)
# - TS_AUTHKEY=tskey-auth-xxx             (Tailscale auth key from admin console)
# - PLEX_CLAIM=claim-xxx                  (optional, from plex.tv/claim)
#
# QUICK START:
# 1. Copy .env.example to .env and fill in values
# 2. docker compose -f docker-compose-portable.yml up -d
# 3. Access via Tailscale IP or localhost

services:
  # ============================================
  # SECRETS MANAGEMENT - Vault
  # ============================================
  # HashiCorp Vault for centralized secret storage
  vault:
    image: hashicorp/vault:latest
    container_name: vault
    restart: unless-stopped
    ports:
      - "8201:8200"
    cap_add:
      - IPC_LOCK
    volumes:
      - vault-data:/vault/data
      - ./vault-config:/vault/config:ro
    entrypoint: vault
    command: server -config=/vault/config/vault.hcl
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://127.0.0.1:8200/v1/sys/health?sealedcode=200&uninitcode=200&standbycode=200"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - flippanet_network

  # ============================================
  # REMOTE ACCESS - Tailscale
  # ============================================
  # Provides secure remote access to all services
  # Ref: https://tailscale.com/kb/1282/docker
  tailscale:
    image: tailscale/tailscale:latest
    container_name: tailscale
    hostname: flippanet
    restart: unless-stopped
    # Use host networking so Tailscale IP is accessible on the host
    # This allows SSH and other services on the host to be reached via Tailscale
    network_mode: host
    deploy:
      resources:
        limits:
          memory: 512m
          cpus: '1.0'
        reservations:
          memory: 128m
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    # Note: sysctls cannot be used with host networking
    # IP forwarding must be enabled on the host system instead:
    # sudo sysctl -w net.ipv4.ip_forward=1
    # sudo sysctl -w net.ipv6.conf.all.forwarding=1
    devices:
      - /dev/net/tun:/dev/net/tun
    volumes:
      - tailscale-state:/var/lib/tailscale
    environment:
      # Auth key from Tailscale admin console (https://login.tailscale.com/admin/settings/keys)
      # Use a reusable key for persistence, or ephemeral for temp access
      - TS_AUTHKEY=${TS_AUTHKEY}
      # Hostname shown in Tailscale admin
      - TS_HOSTNAME=flippanet
      # State directory for persistence
      - TS_STATE_DIR=/var/lib/tailscale
      # Use kernel networking (faster than userspace)
      - TS_USERSPACE=false
      # Advertise Docker network as subnet route (allows access to all containers)
      - TS_ROUTES=172.20.0.0/16
      # DISABLED: TS_ACCEPT_DNS=true caused DNS takeover that broke local network
      # Tailscale's MagicDNS (100.100.100.100) was overriding Docker's DNS (127.0.0.11)
      # and when DNS forwarding failed, it cascaded to break the whole network
      - TS_ACCEPT_DNS=false
      # Extra args - must explicitly set all non-default options
      - TS_EXTRA_ARGS=--accept-routes --advertise-exit-node=false
    # Note: Cannot use 'networks' with network_mode: host
    # networks:
    #   - flippanet_network
    healthcheck:
      test: ["CMD", "tailscale", "status"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ============================================
  # VPN - Gluetun (ProtonVPN)
  # ============================================
  gluetun:
    image: qmcgaw/gluetun:latest
    container_name: gluetun
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 1g
          cpus: '2.0'
        reservations:
          memory: 256m
    cap_add:
      - NET_ADMIN
    devices:
      - /dev/net/tun:/dev/net/tun
    ports:
      # qBittorrent WebUI (routed through VPN)
      - "9080:8080"
      # Torrent ports
      - "6881:6881"
      - "6881:6881/udp"
      # Gluetun control API
      - "8000:8000"
    volumes:
      - gluetun-config:/gluetun
    environment:
      - VPN_SERVICE_PROVIDER=protonvpn
      - VPN_TYPE=wireguard
      # ProtonVPN OpenVPN credentials (+pmp suffix enables port forwarding)
      #- OPENVPN_USER=${PROTONVPN_USER}+pmp
      #- OPENVPN_PASSWORD=${PROTONVPN_PASSWORD}
      # PROTENVPN Wireguard creds
      - WIREGUARD_PRIVATE_KEY=WG0BJ2AWxu3kTmGl6l4syh9GnSkKavh1nIMjwhTE7XE=
      - WIREGUARD_ADDRESSES=10.2.0.2/32
      # PORT_FORWARD_ONLY=on ensures only P2P servers are used
      # (matches your "P2P / Torrent-optimized" profile)
      - PORT_FORWARD_ONLY=on
      - VPN_PORT_FORWARDING=on
      - VPN_PORT_FORWARDING_STATUS_FILE=/gluetun/forwarded_port
      # Let Gluetun pick fastest P2P server (like "Fastest country")
      # Or uncomment to use specific country:
      # - SERVER_COUNTRIES=Netherlands
      - FREE_ONLY=off
      - TZ=${TZ:-America/Chicago}
    networks:
      - flippanet_network
    healthcheck:
      test: ["CMD", "cat", "/gluetun/forwarded_port"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  # ============================================
  # DOWNLOAD CLIENT - qBittorrent
  # ============================================
  qbittorrent:
    image: lscr.io/linuxserver/qbittorrent:latest
    container_name: qbittorrent
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 8g
          cpus: '4.0'
        reservations:
          memory: 1g
    network_mode: "service:gluetun"
    depends_on:
      gluetun:
        condition: service_healthy
    volumes:
      - qbittorrent-config:/config
      - ${DATA_PATH}:/data
      - gluetun-config:/gluetun:ro
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - UMASK=002
      - TZ=${TZ:-America/Chicago}
      - WEBUI_PORT=8080

  # ============================================
  # CLOUDFLARE BYPASS - FlareSolverr
  # ============================================
  # Required for indexers protected by Cloudflare
  # Prowlarr will use this automatically when configured
  flaresolverr:
    image: ghcr.io/flaresolverr/flaresolverr:latest
    container_name: flaresolverr
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 1g
          cpus: '1.0'
        reservations:
          memory: 256m
    ports:
      - "8191:8191"
    environment:
      - LOG_LEVEL=info
      - LOG_HTML=false
      - CAPTCHA_SOLVER=none
      - TZ=${TZ:-America/Chicago}
    networks:
      - flippanet_network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8191/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # ============================================
  # INDEXER MANAGER - Prowlarr
  # ============================================
  prowlarr:
    image: lscr.io/linuxserver/prowlarr:latest
    container_name: prowlarr
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 1g
          cpus: '1.0'
        reservations:
          memory: 256m
    ports:
      - "9696:9696"
    volumes:
      - prowlarr-config:/config
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - UMASK=002
      - TZ=${TZ:-America/Chicago}
    networks:
      - flippanet_network
    depends_on:
      - flaresolverr
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9696/ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # ============================================
  # MOVIES - Radarr
  # ============================================
  radarr:
    image: lscr.io/linuxserver/radarr:latest
    container_name: radarr
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 2g
          cpus: '2.0'
        reservations:
          memory: 512m
    ports:
      - "7878:7878"
    volumes:
      - radarr-config:/config
      - ${DATA_PATH}:/data
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - UMASK=002
      - TZ=${TZ:-America/Chicago}
    networks:
      - flippanet_network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:7878/ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # ============================================
  # TV SHOWS - Sonarr
  # ============================================
  sonarr:
    image: lscr.io/linuxserver/sonarr:latest
    container_name: sonarr
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 2g
          cpus: '2.0'
        reservations:
          memory: 512m
    ports:
      - "8989:8989"
    volumes:
      - sonarr-config:/config
      - ${DATA_PATH}:/data
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - UMASK=002
      - TZ=${TZ:-America/Chicago}
    networks:
      - flippanet_network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8989/ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # ============================================
  # ============================================
  # AUDIOBOOKS - Listenarr
  # ============================================
  # Audiobook automation (actively maintained Readarr alternative)
  # Integrates with Audiobookshelf and Prowlarr
  # Access: http://flippanet:8787
  listenarr:
    image: listenarr:fixed-category
    container_name: listenarr
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 1g
          cpus: '1.0'
        reservations:
          memory: 256m
    ports:
      - "8787:4545"
    volumes:
      - listenarr-config:/app/config
      - ${DATA_PATH}:/data
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - UMASK=002
      - TZ=${TZ:-America/Chicago}
    networks:
      - flippanet_network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4545/ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # ADULT CONTENT - Whisparr
  # ============================================
  # Radarr-like automation for adult content
  # Access: http://flippanet:6969
  # Setup: Add PornoLab indexer in Prowlarr, then connect to Whisparr
  whisparr:
    image: ghcr.io/hotio/whisparr:nightly
    container_name: whisparr
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 1g
          cpus: '1.0'
        reservations:
          memory: 256m
    ports:
      - "6969:6969"
    volumes:
      - whisparr-config:/config
      - ${DATA_PATH}:/data
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - UMASK=002
      - TZ=${TZ:-America/Chicago}
    networks:
      - flippanet_network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6969/ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # ============================================
  # MEDIA SERVER - Plex
  # ============================================
  # Containerized Plex for Orange Pi portability
  # Using network_mode: host on Linux for proper network binding
  # (Plex has issues with Docker's IPv4 port forwarding - it binds IPv6 only)
  plex:
    image: lscr.io/linuxserver/plex:latest
    container_name: plex
    restart: unless-stopped
    # network_mode: host is recommended for Plex on Linux
    # This exposes all Plex ports directly on the host network
    # Ports: 32400 (web), 3005 (companion), 8324 (roku), 32469 (DLNA),
    #        1900/udp (SSDP), 32410-32414/udp (GDM discovery)
    network_mode: host
    deploy:
      resources:
        limits:
          memory: 24g
          cpus: '7.0'
        reservations:
          memory: 4g
    volumes:
      - plex-config:/config
      - ${DATA_PATH}:/data
      # Transcode to /tmp for speed (you have 829GB free on /)
      - /tmp/plex-transcode:/transcode
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-America/Chicago}
      - VERSION=docker
      # Get claim token from https://plex.tv/claim (optional, for linking)
      - PLEX_CLAIM=${PLEX_CLAIM}
    # Note: Cannot use 'networks' with network_mode: host

  # ============================================
  # MEDIA REQUEST PLATFORM - Jellyseerr
  # ============================================
  # Modern fork of Overseerr with Jellyfin support
  # Users can request movies/TV shows via web interface
  # Access: http://flippanet:5055
  jellyseerr:
    image: fallenbagel/jellyseerr:latest
    container_name: jellyseerr
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 1g
          cpus: '1.0'
        reservations:
          memory: 256m
    ports:
      - "5055:5055"
    volumes:
      - jellyseerr-config:/app/config
    environment:
      - LOG_LEVEL=info
      - TZ=${TZ:-America/Chicago}
    networks:
      - flippanet_network
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:5055/api/v1/status"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # ============================================
  # SUBTITLES - Bazarr
  # ============================================
  # Automatic subtitle downloader for Sonarr/Radarr
  # Integrates with opensubtitles.org and other providers
  # Access: http://flippanet:6767
  bazarr:
    image: lscr.io/linuxserver/bazarr:latest
    container_name: bazarr
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 512m
          cpus: '1.0'
        reservations:
          memory: 128m
    ports:
      - "6767:6767"
    volumes:
      - bazarr-config:/config
      - ${DATA_PATH}:/data
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-America/Chicago}
    networks:
      - flippanet_network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6767/api/system/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # ============================================
  # AUDIOBOOKS - Audiobookshelf
  # ============================================
  # Self-hosted audiobook and podcast server
  # Access: http://flippanet:13378
  audiobookshelf:
    image: ghcr.io/advplyr/audiobookshelf:latest
    container_name: audiobookshelf
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 1g
          cpus: '1.0'
        reservations:
          memory: 256m
    ports:
      - "13378:80"
    volumes:
      - ${DATA_PATH}/audiobooks:/audiobooks
      - ${DATA_PATH}/podcasts:/podcasts
      - audiobookshelf-config:/config
      - audiobookshelf-metadata:/metadata
    environment:
      - TZ=${TZ:-America/Chicago}
    networks:
      - flippanet_network
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://127.0.0.1:80/healthcheck"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # ============================================
  # EBOOKS - LazyLibrarian (DISABLED)
  # ============================================
  # Disabled due to lack of Arr-style functionality
  # Recommendations:
  # - Use Calibre for local ebook management
  # - Use Calibre-Web for web access to Calibre library
  # - For automation, consider Readarr (actively maintained)
  #
  # lazylibrarian:
  #   image: lscr.io/linuxserver/lazylibrarian:latest
  #   container_name: lazylibrarian
  #   restart: unless-stopped
  #   ports:
  #     - "5299:5299"
  #   volumes:
  #     - lazylibrarian-config:/config
  #     - ${DATA_PATH}:/data
  #   environment:
  #     - PUID=${PUID:-1000}
  #     - PGID=${PGID:-1000}
  #     - TZ=${TZ:-America/Chicago}
  #   networks:
  #     - flipparr_network

  # ============================================
  # PLEX MONITORING - Tautulli
  # ============================================
  # Analytics and monitoring for Plex
  # Track who's watching what, stats, notifications
  # Note: Plex uses host networking, so connect via host IP or localhost
  tautulli:
    image: lscr.io/linuxserver/tautulli:latest
    container_name: tautulli
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 512m
          cpus: '0.5'
        reservations:
          memory: 128m
    ports:
      - "8181:8181"
    volumes:
      - tautulli-config:/config
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-America/Chicago}
    networks:
      - flippanet_network
    extra_hosts:
      - "plex:host-gateway"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8181/status"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # ============================================
  # QUALITY PROFILES - Recyclarr
  # ============================================
  # Automatically syncs TRaSH Guides quality profiles
  # to Sonarr and Radarr for optimal settings
  recyclarr:
    image: ghcr.io/recyclarr/recyclarr:latest
    container_name: recyclarr
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 256m
          cpus: '0.5'
        reservations:
          memory: 64m
    volumes:
      - recyclarr-config:/config
    environment:
      - TZ=${TZ:-America/Chicago}
    networks:
      - flippanet_network
    depends_on:
      radarr:
        condition: service_healthy
      sonarr:
        condition: service_healthy

  # ============================================
  # DNS & AD BLOCKING - Pi-hole (DISABLED)
  # ============================================
  # Recommended: Run Pi-hole on a separate device (Orange Pi)
  # so DNS stays up when this server reboots/updates
  #
  # To enable later, uncomment this section and run:
  #   docker compose -f docker-compose-portable.yml up -d pihole
  #
  # pihole:
  #   image: jacklul/pihole:latest
  #   container_name: pihole
  #   restart: unless-stopped
  #   ports:
  #     - "53:53/tcp"
  #     - "53:53/udp"
  #     - "8053:80/tcp"
  #   volumes:
  #     - pihole-config:/etc/pihole
  #     - pihole-dnsmasq:/etc/dnsmasq.d
  #     - ./pihole-updatelists.conf:/etc/pihole-updatelists.conf:ro
  #   environment:
  #     - TZ=${TZ:-America/Chicago}
  #     - WEBPASSWORD=${PIHOLE_PASSWORD:-flippanet}
  #     - PIHOLE_DNS_=1.1.1.1;1.0.0.1
  #     - VIRTUAL_HOST=pihole.local
  #     - DNSMASQ_LISTENING=all
#   networks:
#     flippanet_network:
#       ipv4_address: 172.20.0.53
  #   cap_add:
  #     - NET_ADMIN
  #   healthcheck:
  #     test: ["CMD", "dig", "+short", "+norecurse", "+retry=0", "@127.0.0.1", "pi.hole"]
  #     interval: 30s
  #     timeout: 10s
  #     retries: 3

  # ============================================
  # PORT UPDATER - Sidecar
  # ============================================
  port-updater:
    image: curlimages/curl:latest
    container_name: port-updater
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 128m
          cpus: '0.25'
        reservations:
          memory: 32m
    depends_on:
      - gluetun
    volumes:
      - gluetun-config:/gluetun:ro
    environment:
      - QBITTORRENT_HOST=gluetun
      - QBITTORRENT_PORT=8080
      - QBITTORRENT_USER=${QBITTORRENT_USER:-admin}
      - QBITTORRENT_PASS=${QBITTORRENT_PASS:-Y7e7#3@iyAkSQygN}
    networks:
      - flippanet_network
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        echo "Port updater starting..."
        LAST_PORT=""
        while true; do
          PORT=$$(cat /gluetun/forwarded_port 2>/dev/null || echo "")
          if [ -n "$$PORT" ] && [ "$$PORT" != "$$LAST_PORT" ]; then
            echo "New port detected: $$PORT (was: $$LAST_PORT)"
            sleep 5
            COOKIE=$$(curl -s -c - "http://$$QBITTORRENT_HOST:$$QBITTORRENT_PORT/api/v2/auth/login" \
              -d "username=$$QBITTORRENT_USER&password=$$QBITTORRENT_PASS" | grep SID | awk '{print $$7}')
            if [ -n "$$COOKIE" ]; then
              curl -s "http://$$QBITTORRENT_HOST:$$QBITTORRENT_PORT/api/v2/app/setPreferences" \
                -b "SID=$$COOKIE" \
                -d "json={\"listen_port\":$$PORT}"
              echo "Updated qBittorrent port to $$PORT"
              LAST_PORT="$$PORT"
            else
              echo "Failed to login to qBittorrent"
            fi
          fi
          sleep 60
        done

  # ============================================
  # AI ASSISTANT - Open WebUI + SearXNG
  # ============================================
  # Web interface for Ollama with web search capability
  # Access: http://flippanet:3000
  open-webui:
    image: ghcr.io/open-webui/open-webui:main
    container_name: open-webui
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 4g
          cpus: '2.0'
        reservations:
          memory: 512m
    network_mode: host
    environment:
      # Connect directly to host Ollama (host network mode)
      - OLLAMA_BASE_URL=http://localhost:11434
      # Enable web search via SearXNG (use localhost since we're in host network)
      - ENABLE_RAG_WEB_SEARCH=true
      - RAG_WEB_SEARCH_ENGINE=searxng
      - SEARXNG_QUERY_URL=http://localhost:8888/search?q=<query>
      - RAG_WEB_SEARCH_RESULT_COUNT=5
      - RAG_WEB_SEARCH_CONCURRENT_REQUESTS=2
      # General settings
      - WEBUI_AUTH=true
      - DEFAULT_MODELS=qwen2.5:assistant
      # Task model for background tasks (title generation, etc.)
      - TASK_MODEL=llama3.2:task
      # TTS settings (edge-tts voices)
      - TZ=${TZ:-America/Chicago}
      # Port override (default is 8080, but we want 3000)
      - PORT=3000
    volumes:
      - open-webui-data:/app/backend/data
    depends_on:
      - searxng
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # Ollama Bridge - Proxy to connect Docker containers to host Ollama
  # Uses host network to reach Ollama, exposes via port mapping
  ollama-bridge:
    image: alpine/socat:latest
    container_name: ollama-bridge
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 128m
          cpus: '0.25'
        reservations:
          memory: 32m
    network_mode: host
    command: TCP-LISTEN:11435,fork,reuseaddr TCP:127.0.0.1:11434

  # SearXNG - Privacy-respecting metasearch engine
  # Used by Open WebUI for web search
  searxng:
    image: searxng/searxng:latest
    container_name: searxng
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 1g
          cpus: '1.0'
        reservations:
          memory: 256m
    ports:
      - "8888:8080"
    environment:
      - SEARXNG_BASE_URL=http://searxng:8080/
      - TZ=${TZ:-America/Chicago}
    volumes:
      - ./searxng:/etc/searxng:rw
    networks:
      - flippanet_network
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8080"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s



  # ============================================
  # TEXT-TO-SPEECH - OpenAI Edge TTS
  # Provides custom voice options for Open WebUI
  # Access: http://flippanet:5050
  # ============================================
  edge-tts:
    image: travisvn/openai-edge-tts:latest
    container_name: edge-tts
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 512m
          cpus: '0.5'
        reservations:
          memory: 128m
    ports:
      - "5050:5050"
    environment:
      - TZ=${TZ:-America/Chicago}
      # Default voice (can be overridden per request)
      - REQUIRE_API_KEY=False
      - DEFAULT_VOICE=en-IE-ConnorNeural
      # Available voices include:
      # Irish: en-IE-ConnorNeural, en-IE-EmilyNeural
      # Australian: en-AU-WilliamNeural, en-AU-NatashaNeural
      # British: en-GB-RyanNeural, en-GB-SoniaNeural
      # American: en-US-GuyNeural, en-US-JennyNeural
    networks:
      - flippanet_network
    healthcheck:
      test: ["CMD-SHELL", "python3 -c \"import urllib.request; urllib.request.urlopen('http://127.0.0.1:5050/v1/voices')\""]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # ============================================
  # MCP PROXY - MCPO
  # Bridges MCP servers for Open WebUI tool access
  # Access: http://flippanet:8001
  # ============================================
  mcpo:
    image: ghcr.io/open-webui/mcpo:main
    container_name: mcpo
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 1g
          cpus: '1.0'
        reservations:
          memory: 256m
    ports:
      - "8001:8000"
    environment:
      - TZ=${TZ:-America/Chicago}
    volumes:
      - ./mcpo/config.json:/app/config.json:ro
      - ./mcpo-data:/data:rw
    command: ["--config", "/app/config.json", "--port", "8000"]
    networks:
      - flippanet_network
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://127.0.0.1:8000/openapi.json"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

# ============================================
# NETWORKS
# ============================================
networks:
  flippanet_network:
    name: flippanet_network
    driver: bridge
    ipam:
      config:
        # Fixed subnet for Tailscale subnet routing
        - subnet: 172.20.0.0/16

# ============================================
# VOLUMES
# ============================================
# Named volumes for config persistence
# These will be recreated on new host - backup before migration!
volumes:
  listenarr-config:
    name: flippanet_listenarr-config
  tailscale-state:
    name: flippanet_tailscale-state
  gluetun-config:
    name: flippanet_gluetun-config
  qbittorrent-config:
    name: flippanet_qbittorrent-config
  prowlarr-config:
    name: flippanet_prowlarr-config
  radarr-config:
    name: flippanet_radarr-config
  sonarr-config:
    name: flippanet_sonarr-config
  whisparr-config:
    name: flippanet_whisparr-config
  plex-config:
    name: flippanet_plex-config
  jellyseerr-config:
    name: flippanet_jellyseerr-config
  # pihole-config:
  #   name: flippanet_pihole-config
  # pihole-dnsmasq:
  #   name: flippanet_pihole-dnsmasq
  bazarr-config:
    name: flippanet_bazarr-config
  audiobookshelf-config:
    name: flippanet_audiobookshelf-config
  audiobookshelf-metadata:
    name: flippanet_audiobookshelf-metadata
  tautulli-config:
    name: flippanet_tautulli-config
  recyclarr-config:
    name: flippanet_recyclarr-config
  open-webui-data:
    name: flippanet_open-webui-data
  vault-data:
    name: flippanet_vault-data
